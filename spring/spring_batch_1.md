# 스프링 배치
![image_1](./images/image_1.png)<br><br>

### 목차
1. 스프링 배치란?
2. 스프링 배치를 왜 사용하는가?
3. 스프링 배치의 구조
5. 스프링 배치 구현 시 주의해야 하는 사항


<br><br>

### 스프링 배치란? 

스프링 프레임워크 기반에서 작동하는, 대용량 데이터를 처리하기 위한 프레임워크<br>
`배치 : 논리적/물리적으로 관련된 데이터를 그룹화하여 일괄 처리하는 방법.
배치는 대량 처리를 의미하는 것이지, 일정 주기마다 돌아가는 것을 의미하지는 않음`<br><br>

### 스프링 배치를 왜 사용하는가?

* "정해진" 시간대, "사용자가 적은" 시간대에 "대량의 데이터"를 "일괄 처리" 하기 위해 사용한다.<br>
* 스프링 배치는 배치 작업을 트랜잭션 처리와 함께 관리하고, 실패한 작업을 복구하고 재시작할 수 있는 기능을 제공<br>
* 잡(Job), 스텝(Step), 리더(Reader), 프로세서(Processor), 라이터(Writer) 등의 개념을 이용하여 배치 처리를 설계하고 실행<br>
* 커머스 사이트에서 전일의 매출 집계 데이터를 새벽에 생성해두고 워크타임의 요청시간에
집계한 데이터를 주는 방식<br>
* 구독 서비스 -> 정해진 시간에 구독자들에게 메일을 일괄전송<br>
* 데이터백업 -> 사용자 트래픽이 적은 시간대에 배치 처리를 함
<br><br>

### 스프링 배치의 구조
![image_2](./images/image_2.png)<br><br>
* job : 배치 처리과정을 하나의 단위로 만들어 놓은 객체.<br>
* JobRepository : 배치를 수행하는 데 필요한 전반적인 object 를 통칭.<br>
배치 수행과 관련된 수치 데이터와 Job의 상태를 관리하며, 배치와 관련된 CRUD 처리를 수행한다.<br>
* JobLauncher : job을 수행시킨다. job 과 parameter를 받아 배치 수행 후, job Execution 을 반환한다.<br>
spring batch 에서는 JobLauncherApplicationRunner클래스가 자동으로 JobLauncher를 실행하기 때문에 우리가 직접 컨트롤할 일은 없다.<br>
* job instance : job 이 실제로 실행되는 것<br>
* job parameter : 배치 작업이 수행될때 마다 전달되는 Parameter<br>
* job execution : job instance 가 실제로 실행되는 것<br>
* step : Job을 구성하는 독립적인 작업 단위.<br>
* step execution : job instance 가 실제로 실행되는 것<br>
* itemReader: 배치를 수행하는데 있어 대상이 되는 데이터를 읽어들이는데 사용되는 Object<br>
* itemReader: 최종적으로 가공된 데이터를 출력하는 역할을 수행. DB에 해당 내용을 저장할 수도 있고 해당 데이터를 다른 프로젝트로 API 호출시킬 수도, Kafka를 통해 msg 발행시킬 수도 있다.<br>
* itemProcessor : Read와 Write의 중간 단계에서 가공(처리) 역할을 수행 <br><br>

```
상황 : 매일 12시에 DB에서 T_HISTORY 테이블의 데이터를 가져와 T_BACKUP 테이블에 저장한다. 어제는 이 작업이 성공했고, 오늘 이 작업은 실패했다.
Job : T_HISTORY 테이블의 데이터를 select 해와 T_BACKUP 테이블에 insert 하는 작업
Job instance : 오늘과 어제 수행된 작업
Job execution : 실제 실행된 자체. 오늘 job execution 의 결과는 실패이고, 어제 job execution 의 결과는 성공이다.
```
<br>

```
** step 의 방식
Tasklet vs Chunk
Tasklet: 한 가지 이상의 CRUD가 발생(=비즈니스 로직)하는 task에 대해 일괄적으로 처리하는 경우 사용 (복잡한 로직을 수행해야 하는 job일 경우)
Chunk: chunk 단위로 처리할 모든 record를 쭉 읽어들인 후, 모두 읽어들이는데 성공하면 한번에 Write하는 방식 (대용량 데이터에 대해 단순 처리할 경우)
```


### 스프링 배치 구현 시 주의해야 하는 사항
1. 메모리 관리 : 대용량 데이터를 처리할 때 메모리 사용을 주의. 청크 크기를 적절히 조정하고, 필요한 경우 스트리밍 방식을 사용.
2. DB 트랜잭션 : 각 Step이나 청크 단위의 트랜잭션 경계를 잘 설정하여 데이터 정합성을 보장. 트랜잭션 롤백 시 처리 로직 재검토 필요.
3. 재시도 횟수와 오류 건너뛰기를 적절히 구성하여 배치 작업의 안정성을 높임. 
4. 쿼리 및 I/O 작업 최적화 : 병렬 처리 및 파티셔닝을 활용하여 처리 속도를 개선. 

